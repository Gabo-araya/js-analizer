{% extends "base.html" %}

{% block title %}Reporte de Seguridad Mejorado - {{ scan.title or scan.url }}{% endblock %}

{% block head %}
<!-- Enlazar CSS corporativo específico -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-report.css') }}">

<style>
    /* Enhanced Report Styles - Legacy (mantenido por compatibilidad) */
    .report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }

    .report-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .report-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .security-score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto 20px;
    }

    .score-excellent { background-color: #27ae60; }
    .score-good { background-color: #f39c12; }
    .score-poor { background-color: #e74c3c; }

    .section-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
    }

    .section-header {
        background: #34495e;
        color: white;
        padding: 20px;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .section-content {
        padding: 25px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }

    .info-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .info-value {
        color: #34495e;
    }

    .vulnerability-chart {
        width: 300px;
        height: 200px;
        margin: 0 auto;
    }

    .library-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .library-table th,
    .library-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .library-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
    }

    .status-vulnerable {
        background-color: #fdf2f2;
        color: #e74c3c;
    }

    .status-safe {
        background-color: #f0f9f0;
        color: #27ae60;
    }

    .status-unknown {
        background-color: #fff3cd;
        color: #856404;
    }

    .security-header {
        background: #27ae60;
        color: white;
    }

    .missing-header {
        background: #e74c3c;
        color: white;
    }

    .recommendation-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }

    .risk-critical { background-color: #c0392b; color: white; }
    .risk-high { background-color: #e74c3c; color: white; }
    .risk-medium { background-color: #f39c12; color: white; }
    .risk-low { background-color: #f1c40f; color: #2c3e50; }

    .badge-js { background-color: #f7df1e; color: #2c3e50; }
    .badge-css { background-color: #1572b6; color: white; }

    .charts-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        flex-wrap: wrap;
        gap: 30px;
        margin: 30px 0;
    }


    .print-button {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1000;
    }

    @media print {
        .print-button, .navbar, .btn { display: none !important; }
        .report-container { max-width: 100%; }
    }
    </style>

    <!-- CSS-based charts instead of Chart.js -->
    <style>
    .simple-chart {
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
        color: #2c3e50;
    }

    .progress-bar-chart {
        margin-bottom: 10px;
    }

    .progress-bar-chart .label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .progress-bar-chart .bar {
        height: 20px;
        border-radius: 10px;
        position: relative;
        overflow: hidden;
    }

    .bar-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease;
    }

    .pie-chart-alternative {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .stat-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        text-align: center;
        flex-direction: column;
    }

    .stat-circle .number {
        font-size: 1.5rem;
        line-height: 1;
    }

    .stat-circle .label {
        font-size: 0.7rem;
        margin-top: 2px;
    }

    .vulnerable { background-color: #e74c3c; }
    .safe { background-color: #27ae60; }
    .unknown { background-color: #95a5a6; }
    .js-type { background-color: #f7df1e; color: #2c3e50; }
    .css-type { background-color: #1572b6; }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- Print Button Corporativo -->
    <button class="print-button" onclick="window.print()">
        <i class="bi bi-printer"></i>
        Imprimir Reporte
    </button>

    <!-- Dashboard Header Moderno -->
    <div class="dashboard-header dashboard-animate">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="dashboard-title">
                    <i class="bi bi-shield-check me-3"></i>
                    Análisis de Seguridad Web
                </h1>
                <p class="dashboard-subtitle">
                    <i class="bi bi-globe me-2"></i>
                    {{ scan.url }}
                </p>
                <div class="d-flex gap-3 text-white-50">
                    <span><i class="bi bi-calendar-event me-1"></i>{{ scan.scan_date if scan.scan_date else 'N/A' }}</span>
                    <span><i class="bi bi-clock me-1"></i>Generado automáticamente</span>
                    <span><i class="bi bi-laptop me-1"></i>NTG JS Analyzer v2.2</span>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="modern-score-circle {{ 'excellent' if security_analysis.security_score >= 80 else 'good' if security_analysis.security_score >= 60 else 'poor' }}">
                    {{ security_analysis.security_score }}%
                </div>
                <div class="mt-2 text-white-50 small">Puntuación de Seguridad</div>
            </div>
        </div>
    </div>

    <!-- Executive Summary Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.3s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">

                    <i class="bi bi-clipboard-data"></i>
                    <span>Resumen Ejecutivo</span>
                </div>
                <div class="card-body modern-card-body">
                    <div class="executive-summary">
                        <p style="font-size: var(--font-lg); line-height: var(--line-height-relaxed); margin-bottom: var(--space-4);">
                            Este reporte proporciona un análisis de seguridad integral de <strong><a href="{{ scan.url }}" target="_blank">{{ scan.url }}</a></strong>.<br />
                            Se identificaron <strong>{{ libraries|length }}</strong> bibliotecas JavaScript y CSS
                            y evaluó <strong>{{ (security_analysis.present|length + security_analysis.missing|length) if security_analysis else 0 }}</strong>
                            encabezados de seguridad HTTP.
                        </p>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h5 style="color: var(--corp-primary); margin-bottom: var(--space-4);">
                                <i class="bi bi-search" style="color: var(--corp-secondary);"></i>
                                Hallazgos Principales:
                            </h5>
                            <div class="key-findings">
                                <ul>
                                    {% set vulnerable_count = 0 %}
                                    {% for lib in libraries %}
                                        {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                            {% set vulnerable_count = vulnerable_count + 1 %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if vulnerable_count > 0 %}
                                        <li>
                                            <i class="bi bi-exclamation-triangle-fill" style="color: var(--corp-danger);"></i>
                                            <span><strong>{{ vulnerable_count }}</strong> {{ 'librería presenta' if vulnerable_count == 1 else 'bibliotecas presentan' }} potenciales vulnerabilidades de seguridad</span>
                                        </li>
                                    {% endif %}

                                    {% if security_analysis.security_score < 70 %}
                                        <li>
                                            <i class="bi bi-shield-exclamation" style="color: var(--corp-warning);"></i>
                                            <span>Los encabezados de seguridad HTTP requieren mejoras inmediatas (Puntuación: <strong>{{ security_analysis.security_score }}%</strong>)</span>
                                        </li>
                                    {% endif %}

                                    {% if security_analysis.missing|length > 0 %}
                                        <li>
                                            <i class="bi bi-shield-x" style="color: var(--corp-warning);"></i>
                                            <span><strong>{{ security_analysis.missing|length }}</strong> {{ 'encabezado crítico de seguridad está ausente' if security_analysis.missing|length == 1 else 'encabezados críticos de seguridad están ausentes' }}</span>
                                        </li>
                                    {% endif %}

                                    {% if vulnerable_count == 0 and security_analysis.security_score >= 70 %}
                                        <li>
                                            <i class="bi bi-shield-check-fill" style="color: var(--corp-accent);"></i>
                                            <span>Excelente postura de seguridad - No se identificaron vulnerabilidades críticas inmediatas</span>
                                        </li>
                                    {% endif %}

                                    <li>
                                        <i class="bi bi-files" style="color: var(--corp-info);"></i>
                                        <span><strong>{{ file_urls|length if file_urls else 0 }}</strong> archivos estáticos fueron analizados en busca de bibliotecas conocidas</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="row">
                                <!-- Columna izquierda: Gráfico -->
                                <div class="col-lg-6">
                                    <div class="card modern-chart-card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-speedometer2 me-2 text-primary"></i>
                                                Estado General de Seguridad
                                            </h6>
                                        </div>
                                        <div class="card-body text-center" style="height: 320px; display: flex; flex-direction: column; justify-content: center;">
                                            <div style="height: 150px; position: relative;">
                                                <canvas id="executiveGaugeChart"></canvas>
                                            </div>

                                            <!-- Calcular datos para el gauge -->
                                            {% set safe_count = namespace(value=0) %}
                                            {% set vuln_count = namespace(value=0) %}
                                            {% set unknown_count = namespace(value=0) %}

                                            {% for lib in libraries %}
                                                {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                                    {% set vuln_count.value = vuln_count.value + 1 %}
                                                {% elif lib.latest_safe_version %}
                                                    {% set safe_count.value = safe_count.value + 1 %}
                                                {% else %}
                                                    {% set unknown_count.value = unknown_count.value + 1 %}
                                                {% endif %}
                                            {% endfor %}

                                            {% set total_libs = safe_count.value + vuln_count.value + unknown_count.value %}
                                            {% set lib_safety_score = (safe_count.value / total_libs * 100) if total_libs > 0 else 0 %}
                                            {% set combined_score = ((security_analysis.security_score * 0.6) + (lib_safety_score * 0.4)) | round %}

                                            <div class="mt-3">
                                                <h4 class="mb-1" style="color: {{ '#22c55e' if combined_score >= 75 else '#f59e0b' if combined_score >= 50 else '#ef4444' }}">
                                                    {{ combined_score }}%
                                                </h4>
                                                <small class="text-muted">Puntuación General</small>
                                            </div>

                                            <!-- Estadísticas resumidas -->
                                            <div class="chart-summary mt-2">
                                                <div class="d-flex justify-content-center gap-1 flex-wrap">
                                                    {% if combined_score >= 80 %}
                                                        <span class="modern-badge success">
                                                            <i class="bi bi-shield-check-fill"></i>
                                                            Excelente
                                                        </span>
                                                    {% elif combined_score >= 60 %}
                                                        <span class="modern-badge warning">
                                                            <i class="bi bi-shield-exclamation"></i>
                                                            Bueno
                                                        </span>
                                                    {% else %}
                                                        <span class="modern-badge danger">
                                                            <i class="bi bi-shield-x"></i>
                                                            Crítico
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="mt-1">
                                                    <small class="text-muted" style="font-size: 0.75rem;">
                                                        Headers: {{ security_analysis.security_score }}% | Bibliotecas: {{ lib_safety_score | round }}%
                                                    </small>
                                                </div>
                                            </div>

                                            <!-- Datos ocultos para JavaScript -->
                                            <div style="display: none;"
                                                data-combined-score="{{ combined_score }}"
                                                data-headers-score="{{ security_analysis.security_score }}"
                                                data-libraries-score="{{ lib_safety_score | round }}"
                                                data-vulnerable-count="{{ vuln_count.value }}"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Columna derecha: Explicación detallada -->
                                <div class="col-lg-6">
                                    <div class="card modern-chart-card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="bi bi-calculator me-2 text-info"></i>
                                                Metodología de Cálculo
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Fórmula principal -->
                                            <div class="mb-3 p-2" style="background: #e0f2fe; border-radius: 6px; border-left: 4px solid #0277bd;">
                                                <strong class="text-info">Fórmula:</strong><br>
                                                <code style="background: transparent; color: #01579b; font-weight: 500;">
                                                    (Headers HTTP × 60%) + (Seguridad Bibliotecas × 40%)
                                                </code>
                                            </div>

                                            <!-- Variables detalladas -->
                                            <div class="mb-3">
                                                <h6 class="text-primary mb-2">
                                                    <i class="bi bi-list-ul me-1"></i>
                                                    Variables del Cálculo:
                                                </h6>
                                                <div style="font-size: 0.85rem; line-height: 1.4;">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span><strong>Headers HTTP:</strong></span>
                                                        <span class="text-primary fw-bold">{{ security_analysis.security_score }}%</span>
                                                    </div>
                                                    <div class="text-muted ms-2 mb-2" style="font-size: 0.75rem;">
                                                        {{ security_analysis.present|length if security_analysis.present else 0 }} implementados / {{ (security_analysis.present|length + security_analysis.missing|length) if security_analysis else 0 }} evaluados
                                                    </div>

                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span><strong>Bibliotecas Seguras:</strong></span>
                                                        <span class="text-success fw-bold">{{ lib_safety_score | round }}%</span>
                                                    </div>
                                                    <div class="text-muted ms-2 mb-2" style="font-size: 0.75rem;">
                                                        {{ safe_count.value }} seguras / {{ total_libs }} total
                                                    </div>

                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span><strong>Vulnerables:</strong></span>
                                                        <span class="text-danger fw-bold">{{ vuln_count.value }}</span>
                                                    </div>

                                                    <div class="d-flex justify-content-between">
                                                        <span><strong>Sin Datos:</strong></span>
                                                        <span class="text-warning fw-bold">{{ unknown_count.value }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Cálculo paso a paso -->
                                            <div class="mb-3">
                                                <h6 class="text-primary mb-2">
                                                    <i class="bi bi-calculator me-1"></i>
                                                    Cálculo Paso a Paso:
                                                </h6>
                                                <div style="font-size: 0.85rem; line-height: 1.5; background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                                    <div class="mb-1">
                                                        <strong>Paso 1:</strong> Headers × 60%<br>
                                                        <span class="ms-3">{{ security_analysis.security_score }}% × 0.6 = {{ (security_analysis.security_score * 0.6) | round(1) }}</span>
                                                    </div>
                                                    <div class="mb-1">
                                                        <strong>Paso 2:</strong> Bibliotecas × 40%<br>
                                                        <span class="ms-3">{{ lib_safety_score | round }}% × 0.4 = {{ (lib_safety_score * 0.4) | round(1) }}</span>
                                                    </div>
                                                    <div style="border-top: 1px solid #dee2e6; padding-top: 8px;">
                                                        <strong>Resultado:</strong><br>
                                                        <span class="ms-3">{{ (security_analysis.security_score * 0.6) | round(1) }} + {{ (lib_safety_score * 0.4) | round(1) }} = <span class="text-primary fw-bold">{{ combined_score }}%</span></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Interpretación -->
                                            <div>
                                                <h6 class="text-primary mb-2">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Interpretación:
                                                </h6>
                                                <div class="p-2" style="border-radius: 6px; {{ 'background: #d4edda; border-left: 4px solid #28a745;' if combined_score >= 80 else 'background: #fff3cd; border-left: 4px solid #ffc107;' if combined_score >= 60 else 'background: #f8d7da; border-left: 4px solid #dc3545;' }}">
                                                    <span style="font-size: 0.85rem; {{ 'color: #155724;' if combined_score >= 80 else 'color: #856404;' if combined_score >= 60 else 'color: #721c24;' }}">
                                                        {% if combined_score >= 80 %}
                                                            <strong>Excelente seguridad general.</strong> El sitio cumple con las mejores prácticas de seguridad web.
                                                        {% elif combined_score >= 60 %}
                                                            <strong>Seguridad aceptable.</strong> Se recomiendan mejoras para optimizar la postura de seguridad.
                                                        {% else %}
                                                            <strong>Requiere atención inmediata.</strong> Existen vulnerabilidades críticas que deben ser atendidas.
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Risk Severity Analysis Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.35s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Análisis de Severidad de Riesgos</span>
                </div>
                <div class="card-body modern-card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card modern-chart-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-pie-chart me-2 text-danger"></i>
                                        Distribución de Severidad
                                    </h6>
                                </div>
                                <div class="card-body text-center" style="height: 320px; display: flex; flex-direction: column; justify-content: center;">
                                    <div style="height: 200px; position: relative;">
                                        <canvas id="severityDonutChart"></canvas>
                                    </div>

                                    <!-- Calcular datos de severidad -->
                                    {% set critical_count = namespace(value=0) %}
                                    {% set high_count = namespace(value=0) %}
                                    {% set medium_count = namespace(value=0) %}
                                    {% set low_count = namespace(value=0) %}

                                    <!-- Contar vulnerabilidades críticas (bibliotecas vulnerables) -->
                                    {% for lib in libraries %}
                                        {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                            {% set critical_count.value = critical_count.value + 1 %}
                                        {% elif not lib.latest_safe_version %}
                                            {% set medium_count.value = medium_count.value + 1 %}
                                        {% else %}
                                            {% set low_count.value = low_count.value + 1 %}
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Contar headers críticos faltantes -->
                                    {% if security_analysis.missing %}
                                        {% for header in security_analysis.missing %}
                                            {% if header.name in ['Strict-Transport-Security', 'Content-Security-Policy'] %}
                                                {% set high_count.value = high_count.value + 1 %}
                                            {% else %}
                                                {% set medium_count.value = medium_count.value + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    <!-- Estadísticas numéricas debajo del gráfico -->
                                    <div class="chart-summary">
                                        <div class="d-flex justify-content-center gap-1 flex-wrap">
                                            <span class="modern-badge danger" style="font-size: 0.7rem;">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                {{ critical_count.value }} Crítico
                                            </span>
                                            <span class="modern-badge warning" style="font-size: 0.7rem;">
                                                <i class="bi bi-exclamation-circle"></i>
                                                {{ high_count.value }} Alto
                                            </span>
                                            <span class="modern-badge info" style="font-size: 0.7rem;">
                                                <i class="bi bi-info-circle"></i>
                                                {{ medium_count.value }} Medio
                                            </span>
                                            <span class="modern-badge success" style="font-size: 0.7rem;">
                                                <i class="bi bi-check-circle"></i>
                                                {{ low_count.value }} Bajo
                                            </span>
                                        </div>
                                        <div class="mt-1">
                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                Total: {{ critical_count.value + high_count.value + medium_count.value + low_count.value }} elementos evaluados
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Datos ocultos para JavaScript -->
                                    <div style="display: none;"
                                         data-critical-count="{{ critical_count.value }}"
                                         data-high-count="{{ high_count.value }}"
                                         data-medium-count="{{ medium_count.value }}"
                                         data-low-count="{{ low_count.value }}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="mt-3 mt-lg-0">
                                <h5 style="color: var(--corp-primary); margin-bottom: var(--space-4);">
                                    <i class="bi bi-list-check"></i>
                                    Clasificación de Riesgos
                                </h5>

                                <!-- Descripción detallada de categorías -->
                                <div class="risk-categories">
                                    <!-- CRÍTICO: Bibliotecas vulnerables -->
                                    {% set critical_libs = [] %}
                                    {% for lib in libraries %}
                                        {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                            {% set _ = critical_libs.append(lib) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if critical_libs %}
                                    <div class="mb-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="modern-badge danger me-3">CRÍTICO</span>
                                            <strong>Requiere acción inmediata</strong>
                                        </div>
                                        <div class="ms-4">
                                            <small class="text-muted d-block mb-2">Bibliotecas con vulnerabilidades conocidas:</small>
                                            <div class="risk-items">
                                                {% for lib in critical_libs %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="bi bi-exclamation-triangle-fill text-danger me-2" style="font-size: 0.8rem;"></i>
                                                    <code style="background: #fef2f2; color: #dc2626; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;">
                                                        {{ lib.library_name }} {{ lib.version or 'desconocida' }}
                                                    </code>

                                                    <!-- Badge del tipo de biblioteca -->
                                                    <span class="modern-badge {{ lib.type }} ms-2" style="font-size: 0.65rem; padding: 1px 4px;">
                                                        {% if lib.type == 'js' %}
                                                            <i class="bi bi-braces"></i>
                                                            JavaScript
                                                        {% else %}
                                                            <i class="bi bi-palette"></i>
                                                            CSS
                                                        {% endif %}
                                                    </span>

                                                    {% set effective_safe = get_effective_safe_version(lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                                    {% if effective_safe %}
                                                        <small class="text-muted ms-2">→ actualizar a {{ effective_safe }}</small>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- ALTO: Headers críticos faltantes -->
                                    {% set critical_headers = [] %}
                                    {% if security_analysis.missing %}
                                        {% for header in security_analysis.missing %}
                                            {% if header.name in ['Strict-Transport-Security', 'Content-Security-Policy'] %}
                                                {% set _ = critical_headers.append(header) %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}

                                    {% if critical_headers %}
                                    <div class="mb-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="modern-badge warning me-3">ALTO</span>
                                            <strong>Implementación prioritaria</strong>
                                        </div>
                                        <div class="ms-4">
                                            <small class="text-muted d-block mb-2">Headers de seguridad críticos faltantes:</small>
                                            <div class="risk-items">
                                                {% for header in critical_headers %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="bi bi-shield-x text-warning me-2" style="font-size: 0.8rem;"></i>
                                                    <code style="background: #fefcf2; color: #d97706; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;">
                                                        {{ header.name }}
                                                    </code>
                                                    <small class="text-muted ms-2">{{ header.description }}</small>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- MEDIO: Headers menores + bibliotecas sin datos -->
                                    {% set medium_headers = [] %}
                                    {% set medium_libs = [] %}
                                    {% if security_analysis.missing %}
                                        {% for header in security_analysis.missing %}
                                            {% if header.name not in ['Strict-Transport-Security', 'Content-Security-Policy'] %}
                                                {% set _ = medium_headers.append(header) %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {% for lib in libraries %}
                                        {% if not check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) and not lib.latest_safe_version %}
                                            {% set _ = medium_libs.append(lib) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if medium_headers or medium_libs %}
                                    <div class="mb-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="modern-badge info me-3">MEDIO</span>
                                            <strong>Revisión recomendada</strong>
                                        </div>
                                        <div class="ms-4">
                                            {% if medium_headers %}
                                            <small class="text-muted d-block mb-2">Headers de seguridad recomendados:</small>
                                            <div class="risk-items mb-3">
                                                {% for header in medium_headers %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="bi bi-info-circle text-info me-2" style="font-size: 0.8rem;"></i>
                                                    <code style="background: #f0f9ff; color: #0369a1; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;">
                                                        {{ header.name }}
                                                    </code>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}

                                            {% if medium_libs %}
                                            <small class="text-muted d-block mb-2">Bibliotecas sin datos de seguridad:</small>
                                            <div class="risk-items">
                                                {% for lib in medium_libs %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="bi bi-question-circle text-info me-2" style="font-size: 0.8rem;"></i>
                                                    <div class="d-flex align-items-center">
                                                        {% if lib.source_url %}
                                                        <a href="{{ lib.source_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                                            <code style="background: #f0f9ff; color: #0369a1; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; cursor: pointer;">
                                                                {{ lib.library_name }} {{ lib.version or 'desconocida' }}
                                                                <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.7rem;"></i>
                                                            </code>
                                                        </a>
                                                        {% else %}
                                                        <code style="background: #f0f9ff; color: #0369a1; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;">
                                                            {{ lib.library_name }} {{ lib.version or 'desconocida' }}
                                                        </code>
                                                        {% endif %}

                                                        <!-- Badge del tipo de biblioteca -->
                                                        <span class="modern-badge {{ lib.type }} ms-2" style="font-size: 0.65rem; padding: 1px 4px;">
                                                            {% if lib.type == 'js' %}
                                                                <i class="bi bi-braces"></i>
                                                                JavaScript
                                                            {% else %}
                                                                <i class="bi bi-palette"></i>
                                                                CSS
                                                            {% endif %}
                                                        </span>

                                                        <small class="text-muted ms-2">
                                                            {% if lib.source_url %}
                                                                verificar seguridad en origen
                                                            {% else %}
                                                                buscar manualmente
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- BAJO: Elementos seguros -->
                                    {% set safe_libs = [] %}
                                    {% for lib in libraries %}
                                        {% if not check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) and lib.latest_safe_version %}
                                            {% set _ = safe_libs.append(lib) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if safe_libs %}
                                    <div class="mb-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="modern-badge success me-3">BAJO</span>
                                            <strong>Estado aceptable</strong>
                                        </div>
                                        <div class="ms-4">
                                            <small class="text-muted d-block mb-2">Bibliotecas seguras implementadas:</small>
                                            <div class="risk-items">
                                                {% for lib in safe_libs %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <a href="{{ lib.source_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                                        <i class="bi bi-check-circle text-success me-2" style="font-size: 0.8rem;"></i>
                                                        <code style="background: #f0fdf4; color: #166534; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px;">
                                                            {{ lib.library_name }} {{ lib.version or 'desconocida' }}
                                                        </code>
                                                    </a>
                                                    <!-- Badge del tipo de biblioteca -->
                                                    <span class="modern-badge {{ lib.type }} ms-2" style="font-size: 0.65rem; padding: 1px 4px;">
                                                        {% if lib.type == 'js' %}
                                                            <i class="bi bi-braces"></i>
                                                            JavaScript
                                                        {% else %}
                                                            <i class="bi bi-palette"></i>
                                                            CSS
                                                        {% endif %}
                                                    </span>

                                                    <small class="text-success ms-2">✓ versión segura</small>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Recomendación principal -->
                                <div class="mt-4 p-3" style="background: var(--bg-tertiary); border-radius: var(--radius-lg); border-left: 4px solid var(--corp-primary);">
                                    <h6 class="mb-2" style="color: var(--corp-primary);">
                                        <i class="bi bi-lightbulb"></i> Prioridad Recomendada:
                                    </h6>
                                    {% if critical_count.value > 0 %}
                                        <small>Actualizar inmediatamente las {{ critical_count.value }} {{ 'librería vulnerable' if critical_count.value == 1 else 'bibliotecas vulnerables' }} identificadas.</small>
                                    {% elif high_count.value > 0 %}
                                        <small>Implementar los headers de seguridad críticos faltantes (HSTS, CSP).</small>
                                    {% elif medium_count.value > 0 %}
                                        <small>Revisar y mejorar la configuración de seguridad existente.</small>
                                    {% else %}
                                        <small>Mantener el monitoreo continuo y actualizaciones regulares.</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Analysis Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.4s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header security" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-shield-check"></i>
                    <span>Análisis de Encabezados de Seguridad</span>
                </div>
                <div class="card-body modern-card-body">
        <div class="section-content">
            {% if security_analysis.present %}
                <h5 style="color: var(--corp-accent); margin-bottom: var(--space-4);">
                    <i class="bi bi-check-circle-fill"></i>
                    Encabezados de Seguridad Implementados
                </h5>
                <table class="table dashboard-table">
                    <thead>
                        <tr>
                            <th>Encabezado HTTP</th>
                            <th>Valor Configurado</th>
                            <th>Protección Proporcionada</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for header in security_analysis.present %}
                        <tr class="status-safe">
                            <td>
                                <strong style="color: var(--corp-primary);">{{ header.name }}</strong>
                            </td>
                            <td>
                                <code style="background: var(--bg-tertiary); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-xs);">
                                    {{ header.value[:60] }}{{ '...' if header.value|length > 60 else '' }}
                                </code>
                            </td>
                            <td style="color: var(--text-secondary); line-height: var(--line-height-relaxed);">
                                {{ header.description }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if security_analysis.missing %}
                <h5 style="color: var(--corp-danger); margin: var(--space-6) 0 var(--space-4) 0;">
                    <i class="bi bi-x-circle-fill"></i>
                    Encabezados de Seguridad Faltantes
                </h5>
                <table class="table dashboard-table">
                    <thead>
                        <tr>
                            <th>Encabezado Faltante</th>
                            <th>Nivel de Riesgo</th>
                            <th>Configuración Recomendada</th>
                            <th>Impacto en Seguridad</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set risk_levels = {
                            'Strict-Transport-Security': 'CRITICAL',
                            'Content-Security-Policy': 'CRITICAL',
                            'X-Frame-Options': 'HIGH',
                            'X-Content-Type-Options': 'MEDIUM',
                            'X-XSS-Protection': 'MEDIUM',
                            'Referrer-Policy': 'LOW',
                            'Permissions-Policy': 'LOW'
                        } %}
                        {% for header in security_analysis.missing %}
                        {% set risk_level = risk_levels.get(header.name, 'MEDIUM') %}
                        <tr class="status-vulnerable">
                            <td>
                                <strong style="color: var(--corp-primary);">{{ header.name }}</strong>
                            </td>
                            <td>
                                <span class="modern-badge {{ 'danger' if risk_level in ['CRITICAL', 'HIGH'] else 'warning' if risk_level == 'MEDIUM' else 'info' }}">
                                    {% if risk_level == 'CRITICAL' %}
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                    {% elif risk_level == 'HIGH' %}
                                        <i class="bi bi-exclamation-circle"></i>
                                    {% elif risk_level == 'MEDIUM' %}
                                        <i class="bi bi-info-circle"></i>
                                    {% else %}
                                        <i class="bi bi-dash-circle"></i>
                                    {% endif %}
                                    {{ risk_level }}
                                </span>
                            </td>
                            <td>
                                <code style="background: var(--bg-tertiary); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-xs); word-break: break-all;">
                                    {{ header.recommendation[:50] }}{{ '...' if header.recommendation|length > 50 else '' }}
                                </code>
                            </td>
                            <td style="color: var(--text-secondary); line-height: var(--line-height-relaxed);">
                                {{ header.description }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Library Analysis Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.5s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header libraries">
                    <i class="bi bi-bookshelf"></i>
                    <span>Análisis de Bibliotecas JavaScript y CSS</span>
                </div>
                <div class="card-body modern-card-body">
        <div class="section-content">
            {% if libraries %}
                <!-- Chart.js Interactive Charts -->
                <div class="row mb-4">
                    <div class="col-lg-6 mb-4">
                        <div class="card modern-chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-shield-check me-2 text-primary"></i>
                                    Estado de Seguridad
                                </h6>
                            </div>
                            <div class="card-body" style="height: 320px; position: relative;">
                                <div style="height: 200px; position: relative;">
                                    <canvas id="securityDonutChart"></canvas>
                                </div>
                                <!-- Estadísticas numéricas debajo del gráfico -->
                                {% set vuln_count = namespace(value=0) %}
                                {% set safe_count = namespace(value=0) %}
                                {% set unknown_count = namespace(value=0) %}
                                {% for lib in libraries %}
                                    {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                        {% set vuln_count.value = vuln_count.value + 1 %}
                                    {% elif lib.latest_safe_version %}
                                        {% set safe_count.value = safe_count.value + 1 %}
                                    {% else %}
                                        {% set unknown_count.value = unknown_count.value + 1 %}
                                    {% endif %}
                                {% endfor %}
                                <div class="chart-summary">
                                    <div class="text-center">
                                        <span class="modern-badge danger me-2">
                                            <i class="bi bi-exclamation-triangle-fill"></i>
                                            {{ vuln_count.value }} Vulnerables
                                        </span>
                                        <span class="modern-badge success me-2">
                                            <i class="bi bi-shield-check"></i>
                                            {{ safe_count.value }} Seguras
                                        </span>
                                        <span class="modern-badge warning">
                                            <i class="bi bi-question-circle"></i>
                                            {{ unknown_count.value }} Sin Datos
                                        </span>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <small class="text-muted">
                                            Total: {{ vuln_count.value + safe_count.value + unknown_count.value }} bibliotecas analizadas
                                        </small>
                                    </div>
                                </div>
                                <div style="display: none;"
                                     data-vuln-count="{{ vuln_count.value }}"
                                     data-safe-count="{{ safe_count.value }}"
                                     data-unknown-count="{{ unknown_count.value }}"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card modern-chart-card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-speedometer2 me-2 text-info"></i>
                                    Puntuación General
                                </h6>
                            </div>
                            <div class="card-body text-center" style="height: 320px; display: flex; flex-direction: column; justify-content: center;">
                                <div style="height: 120px; position: relative;">
                                    <canvas id="securityGaugeChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <h4 class="mb-1" style="color: {{ '#22c55e' if security_analysis.security_score >= 75 else '#f59e0b' if security_analysis.security_score >= 50 else '#ef4444' }}">
                                        {{ security_analysis.security_score }}%
                                    </h4>
                                    <small class="text-muted">Puntuación de Seguridad</small>
                                </div>
                                <!-- Estadísticas numéricas adicionales -->
                                <div class="chart-summary mt-2">
                                    <div class="d-flex justify-content-center gap-2 flex-wrap">
                                        {% if security_analysis.security_score >= 80 %}
                                            <span class="modern-badge success">
                                                <i class="bi bi-star-fill"></i>
                                                Excelente
                                            </span>
                                        {% elif security_analysis.security_score >= 60 %}
                                            <span class="modern-badge warning">
                                                <i class="bi bi-check-circle"></i>
                                                Bueno
                                            </span>
                                        {% else %}
                                            <span class="modern-badge danger">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                Necesita Mejoras
                                            </span>
                                        {% endif %}
                                        <span class="modern-badge info">
                                            <i class="bi bi-shield"></i>
                                            {{ security_analysis.present|length if security_analysis.present else 0 }}/{{ (security_analysis.present|length + security_analysis.missing|length) if security_analysis else 0 }} Headers
                                        </span>
                                    </div>
                                </div>
                                <!-- Datos ocultos para JavaScript -->
                                <div style="display: none;" data-security-score="{{ security_analysis.security_score }}"></div>
                            </div>
                        </div>
                    </div>
                <h5 style="color: var(--corp-primary); margin: var(--space-6) 0 var(--space-4) 0;">
                    <i class="bi bi-graph-up"></i>
                    Métricas Adicionales de Análisis
                </h5>
                <div class="charts-container">
                    <div class="simple-chart">
                        <div class="chart-title">Distribución de Tamaños de Archivos</div>
                            {% set small_count = namespace(value=0) %}
                            {% set medium_count = namespace(value=0) %}
                            {% set large_count = namespace(value=0) %}
                            {% set huge_count = namespace(value=0) %}
                            {% for file in file_urls %}
                                {% if file.file_size %}
                                    {% set size_kb = file.file_size / 1024 %}
                                    {% if size_kb < 50 %}
                                        {% set small_count.value = small_count.value + 1 %}
                                    {% elif size_kb < 200 %}
                                        {% set medium_count.value = medium_count.value + 1 %}
                                    {% elif size_kb < 500 %}
                                        {% set large_count.value = large_count.value + 1 %}
                                    {% else %}
                                        {% set huge_count.value = huge_count.value + 1 %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            <div class="stats-grid">
                                <div class="stat-circle" style="background-color: var(--corp-accent);">
                                    <div class="number">{{ small_count.value }}</div>
                                    <div class="label">Pequeños</div>
                                </div>
                                <div class="stat-circle" style="background-color: var(--corp-warning);">
                                    <div class="number">{{ medium_count.value }}</div>
                                    <div class="label">Medianos</div>
                                </div>
                                <div class="stat-circle" style="background-color: #e67e22;">
                                    <div class="number">{{ large_count.value }}</div>
                                    <div class="label">Grandes</div>
                                </div>
                                <div class="stat-circle" style="background-color: var(--corp-danger);">
                                    <div class="number">{{ huge_count.value }}</div>
                                    <div class="label">Muy Grandes</div>
                                </div>
                            </div>
                            <div style="margin-top: var(--space-4); font-size: var(--font-xs); color: var(--text-muted); text-align: center;">
                                <div>Pequeños: &lt; 50KB | Medianos: 50-200KB | Grandes: 200-500KB | Muy Grandes: &gt; 500KB</div>
                            </div>
                        </div>
                    </div>
                    <div class="simple-chart">
                        <div class="chart-title">Estado de Cabeceras de Seguridad</div>
                            {% set present_count = security_analysis.present | length if security_analysis.present else 0 %}
                            {% set missing_count = security_analysis.missing | length if security_analysis.missing else 0 %}
                            {% set total_headers = present_count + missing_count %}
                            {% if total_headers > 0 %}
                            <div class="progress-bar-chart">
                                <div class="label">
                                    <span><i class="bi bi-shield-check"></i> Implementadas</span>
                                    <span><strong>{{ present_count }}</strong> ({{ ((present_count / total_headers) * 100) | round }}%)</span>
                                </div>
                                <div class="bar">
                                    <div class="bar-fill" style="width: {{ (present_count / total_headers) * 100 }}%; background-color: var(--corp-accent);"></div>
                                </div>
                            </div>
                            <div class="progress-bar-chart">
                                <div class="label">
                                    <span><i class="bi bi-shield-x"></i> Faltantes</span>
                                    <span><strong>{{ missing_count }}</strong> ({{ ((missing_count / total_headers) * 100) | round }}%)</span>
                                </div>
                                <div class="bar">
                                    <div class="bar-fill" style="width: {{ (missing_count / total_headers) * 100 }}%; background-color: var(--corp-danger);"></div>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-center text-muted">No hay información de cabeceras</p>
                            {% endif %}
                        </div>
                    </div>
                </div>


                <h5 style="color: var(--corp-primary); margin: var(--space-6) 0 var(--space-4) 0;">
                    <i class="bi bi-bookshelf"></i>
                    Inventario Detallado de Bibliotecas
                </h5>
                <table class="table dashboard-table">
                    <thead>
                        <tr>
                            <th>Biblioteca / Framework</th>
                            <th>Versión Actual</th>
                            <th>Tecnología</th>
                            <th>Estado de Seguridad</th>
                            <th>Acción Recomendada</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lib in libraries %}
                        {% set effective_safe = get_effective_safe_version(lib.latest_safe_version, lib.gl_latest_safe_version) %}
                        {% set has_vuln = check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                        <tr class="{{ 'status-vulnerable' if has_vuln else 'status-safe' if lib.latest_safe_version else 'status-unknown' }}">
                            <td>
                                <div style="display: flex; flex-direction: column; gap: var(--space-1);">
                                    <strong style="color: var(--corp-primary); font-size: var(--font-sm);">{{ lib.library_name }}</strong>
                                    {% if lib.source_url %}
                                        <small style="color: var(--text-muted); font-size: var(--font-xs); word-break: break-all;">
                                            {{ lib.source_url[:40] }}{{ '...' if lib.source_url|length > 40 else '' }}
                                        </small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <code style="background: var(--bg-tertiary); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-xs);">
                                    {{ lib.version or 'Desconocida' }}
                                </code>
                            </td>
                            <td>
                                <span class="modern-badge {{ lib.type }}">
                                    {% if lib.type == 'js' %}
                                        <i class="bi bi-braces"></i>
                                        JavaScript
                                    {% else %}
                                        <i class="bi bi-palette"></i>
                                        CSS
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if has_vuln %}
                                    <span class="modern-badge danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        VULNERABLE
                                    </span>
                                {% elif lib.latest_safe_version %}
                                    <span class="modern-badge success">
                                        <i class="bi bi-shield-check"></i>
                                        SEGURA
                                    </span>
                                {% else %}
                                    <span class="modern-badge warning">
                                        <i class="bi bi-question-circle"></i>
                                        SIN DATOS
                                    </span>
                                {% endif %}
                            </td>
                            <td style="color: var(--text-secondary); font-size: var(--font-sm);">
                                {% if has_vuln %}
                                    <strong style="color: var(--corp-danger);">Actualizar urgentemente</strong><br>
                                    <small>Versión segura: {{ effective_safe or 'Consultar documentación' }}</small>
                                {% elif lib.latest_safe_version %}
                                    <span style="color: var(--corp-accent);">✓ Versión actual es segura</span><br>
                                    <small>Continúe monitoreando actualizaciones</small>
                                {% else %}
                                    <span style="color: var(--corp-warning);">Revisión manual requerida</span><br>
                                    <small>Verificar en base de datos CVE</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-bookshelf display-4 text-muted"></i>
                    <h5 class="mt-3">No se Detectaron Bibliotecas</h5>
                    <p class="text-muted">No se detectaron automáticamente bibliotecas JavaScript o CSS en este sitio web.</p>
                </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Details Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.6s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header technical">
                    <i class="bi bi-gear"></i>
                    <span>Detalles Técnicos del Análisis</span>
                </div>
                <div class="card-body modern-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Dominio</div>
                    <div class="info-value">{{ scan.url.split('://')[1].split('/')[0] }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Título de la Página</div>
                    <div class="info-value">{{ scan.title or 'No se encontró título' }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Archivos JS</div>
                    <div class="info-value">{{ file_urls | selectattr('file_type', 'equalto', 'js') | list | length }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Archivos CSS</div>
                    <div class="info-value">{{ file_urls | selectattr('file_type', 'equalto', 'css') | list | length }}</div>
                </div>
            </div>

            {% if file_urls %}
            <h5 class="mt-4"><i class="bi bi-files"></i> Todos los Archivos Analizados ({{ file_urls|length }})</h5>
            <table class="table dashboard-table">
                <thead>
                    <tr>
                        <th>URL del Archivo</th>
                        <th>Tipo</th>
                        <th>Tamaño</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in file_urls %}
                    <tr class="{{ 'table-danger' if file.status_code and file.status_code != 200 else '' }}">
                        <td><small>{{ file.file_url | truncate_left(60) }}</small></td>
                        <td><span class="modern-badge {{ file.file_type }}">{{ file.file_type.upper() }}</span></td>
                        <td>{{ (file.file_size / 1024) | round(1) if file.file_size else 'Desconocido' }} KB</td>
                        <td>
                            {% if file.status_code == 200 %}
                                <span class="modern-badge success">{{ file.status_code }}</span>
                            {% elif file.status_code %}
                                <span class="modern-badge danger">{{ file.status_code }}</span>
                            {% else %}
                                <span class="modern-badge info">Desconocido</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.7s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header recommendations">
                    <i class="bi bi-lightbulb"></i>
                    <span>Recomendaciones de Seguridad</span>
                </div>
                <div class="card-body modern-card-body">
            {% if security_analysis.missing %}
            <h5><i class="bi bi-shield-plus"></i> Implementar Encabezados de Seguridad Faltantes:</h5>
            {% for header in security_analysis.missing[:3] %}
            <div class="recommendation-box">
                <strong>{{ header.name }}:</strong> {{ header.recommendation }}<br>
                <small class="text-muted">{{ header.description }}</small>
            </div>
            {% endfor %}
            {% endif %}

            {% set vuln_lib_count = 0 %}
            {% set shown_vuln_libs = 0 %}
            {% for lib in libraries %}
                {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) %}
                    {% set vuln_lib_count = vuln_lib_count + 1 %}
                {% endif %}
            {% endfor %}
            {% if vuln_lib_count > 0 %}
            <h5 class="mt-4"><i class="bi bi-arrow-up-circle"></i> Actualizar Bibliotecas Vulnerables:</h5>
            {% for lib in libraries %}
                {% if check_vulnerability_with_global(lib.version, lib.latest_safe_version, lib.gl_latest_safe_version) and shown_vuln_libs < 3 %}
                    {% set shown_vuln_libs = shown_vuln_libs + 1 %}
                    <div class="recommendation-box">
                        <strong>{{ lib.library_name }}:</strong> Update from {{ lib.version or 'unknown' }} to {{ lib.latest_safe_version }}
                    </div>
                {% endif %}
            {% endfor %}
            {% endif %}

            {% if security_analysis.security_score < 70 %}
            <h5 class="mt-4"><i class="bi bi-graph-up-arrow"></i> Mejorar Puntaje de Seguridad:</h5>
            <div class="recommendation-box">
                • Implementar política de seguridad de contenido integral (CSP)<br>
                • Habilitar seguridad de transporte estricta HTTP (HSTS)<br>
                • Configurar encabezado X-Frame-Options apropiado
            </div>
            {% endif %}

            {% if not security_analysis.missing and not vulnerable_libs and security_analysis.security_score >= 70 %}
            <h5><i class="bi bi-check-circle"></i> Buena Postura de Seguridad:</h5>
            <div class="recommendation-box">
                • Continuar monitoreando nuevas vulnerabilidades<br>
                • Actualizar regularmente bibliotecas y dependencias<br>
                • Implementar herramientas de monitoreo de seguridad
            </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Dashboard -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card modern-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body text-center py-4">
                    <img src="{{ url_for('static', filename='img/favicon.png') }}" alt="Newtenberg" class="display-4 mb-3 opacity-75" style="width: 30px; height: 30px; margin-right: 10px;">
                    <h5><i class="bi bi-cpu me-2"></i> Análisis de Seguridad Web</h5>
                    <p class="mb-0 opacity-75">
                        <i class="bi bi-clock me-2"></i>{{ scan.scan_date if scan.scan_date else 'Fecha no disponible' }}
                        <span class="mx-3">|</span>
                         URL: {{ scan.url }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Chart.js CDN - Versión UMD más compatible -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
// Verificar carga y luego inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎨 DOM listo, verificando Chart.js...');

    // Pequeño delay para asegurar que Chart.js esté listo
    setTimeout(function() {
        if (typeof Chart !== 'undefined') {
            console.log('✅ Chart.js disponible, inicializando gráficos...');
            initAllCharts();
        } else {
            console.error('❌ Chart.js no está disponible');
            showChartError();
        }
    }, 500);
});

// Función principal para inicializar todos los gráficos
function initAllCharts() {
    // Extraer datos de los elementos HTML
    const chartData = extractChartData();

    if (chartData) {
        console.log('📊 Datos extraídos:', chartData);

        // Inicializar gráficos
        initSecurityDonut(chartData.security);
        initSecurityGauge(chartData.securityScore);
        initExecutiveGauge(chartData.executiveScore);

        // Inicializar donut de severidad solo si los datos están disponibles
        if (chartData.severity) {
            initSeverityDonut(chartData.severity);
        } else {
            console.warn('⚠️ Datos de severidad no disponibles, omitiendo gráfico');
        }
    } else {
        console.warn('⚠️ No se pudieron extraer los datos');
    }
}

// Extraer datos de los elementos HTML
function extractChartData() {
    try {
        const vulnEl = document.querySelector('[data-vuln-count]');
        const safeEl = document.querySelector('[data-safe-count]');
        const unknownEl = document.querySelector('[data-unknown-count]');
        const scoreEl = document.querySelector('[data-security-score]');
        const executiveEl = document.querySelector('[data-combined-score]');
        const severityEl = document.querySelector('[data-critical-count]');

        if (!vulnEl || !safeEl || !unknownEl || !scoreEl || !executiveEl) {
            console.warn('⚠️ No se encontraron todos los elementos de datos básicos');
            return null;
        }

        const chartData = {
            security: {
                vulnerable: parseInt(vulnEl.dataset.vulnCount) || 0,
                safe: parseInt(safeEl.dataset.safeCount) || 0,
                unknown: parseInt(unknownEl.dataset.unknownCount) || 0
            },
            securityScore: parseInt(scoreEl.dataset.securityScore) || 0,
            executiveScore: {
                combined: parseInt(executiveEl.dataset.combinedScore) || 0,
                headers: parseInt(executiveEl.dataset.headersScore) || 0,
                libraries: parseInt(executiveEl.dataset.librariesScore) || 0,
                vulnerabilities: parseInt(executiveEl.dataset.vulnerableCount) || 0
            }
        };

        // Agregar datos de severidad solo si están disponibles
        if (severityEl) {
            chartData.severity = {
                critical: parseInt(severityEl.dataset.criticalCount) || 0,
                high: parseInt(severityEl.dataset.highCount) || 0,
                medium: parseInt(severityEl.dataset.mediumCount) || 0,
                low: parseInt(severityEl.dataset.lowCount) || 0
            };
        }

        return chartData;
    } catch (error) {
        console.error('❌ Error extrayendo datos:', error);
        return null;
    }
}

// Inicializar gráfico donut de seguridad
function initSecurityDonut(data) {
    const ctx = document.getElementById('securityDonutChart');
    if (!ctx) return;

    const total = data.vulnerable + data.safe + data.unknown;
    if (total === 0) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Vulnerables', 'Seguras', 'Sin Datos'],
            datasets: [{
                data: [data.vulnerable, data.safe, data.unknown],
                backgroundColor: ['#ef4444', '#22c55e', '#94a3b8'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                }
            }
        }
    });

    console.log('✅ Gráfico donut inicializado');
}


// Inicializar gauge de puntuación
function initSecurityGauge(score) {
    const ctx = document.getElementById('securityGaugeChart');
    if (!ctx) return;

    let scoreColor = '#22c55e';
    if (score < 50) scoreColor = '#ef4444';
    else if (score < 75) scoreColor = '#f59e0b';

    const remaining = 100 - score;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, remaining],
                backgroundColor: [scoreColor, '#f1f5f9'],
                borderWidth: 0,
                cutout: '80%'
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            }
        }
    });

    console.log('✅ Gauge inicializado');
}

// Inicializar gauge del resumen ejecutivo
function initExecutiveGauge(scoreData) {
    const ctx = document.getElementById('executiveGaugeChart');
    if (!ctx) return;

    const score = scoreData.combined;
    let scoreColor = '#22c55e';
    if (score < 50) scoreColor = '#ef4444';
    else if (score < 75) scoreColor = '#f59e0b';

    const remaining = 100 - score;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, remaining],
                backgroundColor: [scoreColor, '#f1f5f9'],
                borderWidth: 0,
                cutout: '80%'
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.dataIndex === 0) {
                                return `Puntuación General: ${score}%`;
                            }
                            return null;
                        },
                        afterBody: function() {
                            return [
                                `Headers HTTP: ${scoreData.headers}%`,
                                `Seguridad Bibliotecas: ${scoreData.libraries}%`,
                                `Vulnerabilidades: ${scoreData.vulnerabilities}`
                            ];
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 1800,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('✅ Gauge ejecutivo inicializado');
}

// Inicializar donut de severidad de riesgos
function initSeverityDonut(data) {
    const ctx = document.getElementById('severityDonutChart');
    if (!ctx) return;

    const total = data.critical + data.high + data.medium + data.low;
    if (total === 0) {
        // Mostrar estado vacío
        ctx.parentElement.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-info-circle display-4 mb-3"></i>
                <h6>No hay datos para analizar</h6>
                <small>No se encontraron elementos para clasificar</small>
            </div>
        `;
        return;
    }

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Crítico', 'Alto', 'Medio', 'Bajo'],
            datasets: [{
                data: [data.critical, data.high, data.medium, data.low],
                backgroundColor: [
                    '#ef4444', // Crítico - Rojo
                    '#f59e0b', // Alto - Amarillo/Naranja
                    '#3b82f6', // Medio - Azul
                    '#22c55e'  // Bajo - Verde
                ],
                borderWidth: 2,
                borderColor: '#fff',
                hoverBorderWidth: 3,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { size: 11, weight: '500' },
                        generateLabels: function(chart) {
                            const dataset = chart.data.datasets[0];
                            return chart.data.labels.map((label, i) => {
                                const value = dataset.data[i];
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                                return {
                                    text: `${label}: ${value} (${percentage}%)`,
                                    fillStyle: dataset.backgroundColor[i],
                                    strokeStyle: dataset.backgroundColor[i],
                                    pointStyle: 'circle',
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        title: function(context) {
                            return context[0].label + ' Riesgo';
                        },
                        label: function(context) {
                            const value = context.parsed;
                            const percentage = ((value / total) * 100).toFixed(1);
                            const descriptions = {
                                0: 'Vulnerabilidades conocidas - Acción inmediata',
                                1: 'Headers críticos faltantes - Implementar pronto',
                                2: 'Revisión recomendada - Mejorar cuando sea posible',
                                3: 'Estado aceptable - Mantener monitoreo'
                            };
                            return [
                                `${value} elementos (${percentage}%)`,
                                descriptions[context.dataIndex] || ''
                            ];
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'nearest'
            }
        }
    });

    console.log('✅ Donut de severidad inicializado');
}

// Mostrar error si Chart.js no carga
function showChartError() {
    const containers = ['securityDonutChart', 'techBarChart', 'securityGaugeChart', 'executiveGaugeChart', 'severityDonutChart'];

    containers.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            canvas.parentElement.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h6>Error cargando gráficos</h6>
                    <small>Chart.js no disponible</small>
                </div>
            `;
        }
    });
}
</script>
{% endblock %}
