{% extends "base.html" %}

{% block title %}Reporte Consolidado de Proyecto - {{ project.name }}{% endblock %}

{% block head %}
<!-- Reutilizar CSS del enhanced_report -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced-report.css') }}">

<style>
    /* Estilos adicionales espec√≠ficos para el reporte de proyecto */
    .project-metadata {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .project-metadata span {
        background: rgba(255,255,255,0.2);
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .urls-analysis-section {
        margin: 30px 0;
    }

    .url-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
        border-left: 4px solid #3498db;
    }

    .url-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
    }

    .url-title {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
        word-break: break-all;
    }

    .url-meta {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }

    .url-content {
        padding: 20px;
    }

    .url-libraries, .url-security {
        margin-bottom: 20px;
    }

    .library-usage-info {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.85rem;
    }

    .usage-urls {
        margin-top: 5px;
    }

    .usage-url {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin: 2px;
        text-decoration: none;
    }

    /* Nuevos estilos para URLs completas */
    .usage-urls-full {
        margin-top: 8px;
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 8px;
        background-color: #f8f9fa;
    }

    .usage-url-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        padding: 2px 0;
    }

    .usage-url-item:last-child {
        margin-bottom: 0;
    }

    .usage-url-link {
        color: #0066cc;
        text-decoration: none;
        font-size: 0.85rem;
        word-break: break-all;
        line-height: 1.3;
    }

    .usage-url-link:hover {
        color: #004499;
        text-decoration: underline;
    }

    .consolidated-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-top: 4px solid #3498db;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .project-breadcrumb {
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .consolidated-headers-matrix {
        overflow-x: auto;
        margin: 20px 0;
    }

    .headers-matrix-table {
        width: 100%;
        min-width: 800px;
        border-collapse: collapse;
    }

    .headers-matrix-table th,
    .headers-matrix-table td {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        text-align: center;
        font-size: 0.85rem;
    }

    .headers-matrix-table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .header-present {
        background: #d4edda !important;
        color: #155724;
    }

    .header-missing {
        background: #f8d7da !important;
        color: #721c24;
    }

    .url-column {
        max-width: 200px;
        word-break: break-all;
        text-align: left !important;
    }

    /* Matrix Heatmap Styles - Simplified Table Layout */
    .heatmap-container {
        width: 100%;
        overflow-x: auto;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
    }

    .heatmap-table {
        width: 100%;
        min-width: 1400px;
        border-collapse: separate;
        border-spacing: 3px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .heatmap-table th {
        background-color: #495057;
        color: white;
        padding: 12px 6px;
        text-align: center;
        font-weight: 600;
        font-size: 0.75rem;
        border-radius: 6px;
        line-height: 1.2;
        vertical-align: middle;
        min-width: 50px;
    }

    .heatmap-table th.url-header {
        background-color: #343a40;
        width: 300px;
        min-width: 250px;
        text-align: left;
        padding-left: 15px;
    }

    .heatmap-table td {
        padding: 12px 6px;
        text-align: center;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: help;
        position: relative;
        min-width: 50px;
    }

    .heatmap-table td.url-cell {
        background-color: #e9ecef;
        color: #495057;
        text-align: left;
        padding-left: 15px;
        font-size: 0.8rem;
        line-height: 1.3;
        width: 300px;
        min-width: 250px;
        word-break: break-all;
        font-weight: 500;
    }

    .heatmap-table td.data-cell {
        font-size: 1.4rem;
        font-weight: bold;
        min-width: 45px;
        height: 45px;
        vertical-align: middle;
    }

    .heatmap-table td.data-cell.present {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .heatmap-table td.data-cell.missing {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .heatmap-table td.data-cell:hover {
        transform: scale(1.15);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 100;
        position: relative;
        border-width: 3px;
    }

    .heatmap-table td.data-cell.present:hover {
        background-color: #c3e6cb;
        border-color: #28a745;
    }

    .heatmap-table td.data-cell.missing:hover {
        background-color: #f5c6cb;
        border-color: #dc3545;
    }

    /* Heatmap Legend */
    .heatmap-legend {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
        margin-top: 15px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .legend-dot {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        font-weight: bold;
        border: 2px solid;
    }

    .legend-dot.present {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }

    .legend-dot.missing {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }

    /* Headers Abbreviations Legend */
    .headers-abbreviations {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

    .headers-abbreviations h6 {
        color: #495057;
        font-weight: 600;
    }

    .headers-abbreviations .row {
        line-height: 1.6;
    }

    .headers-abbreviations strong {
        color: #343a40;
        display: block;
        margin-bottom: 5px;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .heatmap-table {
            min-width: 1200px;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 8px 4px;
            font-size: 0.75rem;
        }

        .heatmap-table td.data-cell {
            font-size: 1.2rem;
            min-width: 35px;
            height: 35px;
        }

        .heatmap-table th.url-header,
        .heatmap-table td.url-cell {
            width: 200px;
            min-width: 180px;
            font-size: 0.7rem;
        }
    }

    @media (max-width: 768px) {
        .heatmap-container {
            padding: 10px;
        }

        .heatmap-table {
            min-width: 600px;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 6px 2px;
            font-size: 0.7rem;
        }

        .heatmap-table td.data-cell {
            font-size: 1rem;
            min-width: 30px;
            height: 30px;
        }
    }
</style>

<!-- Copiar CSS inline de enhanced_report.html para compatibilidad -->
<style>
    /* Enhanced Report Styles - Legacy (mantenido por compatibilidad) */
    .report-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
    }

    .report-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .report-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .security-score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto 20px;
    }

    .score-excellent { background-color: #27ae60; }
    .score-good { background-color: #f39c12; }
    .score-poor { background-color: #e74c3c; }

    .section-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow: hidden;
    }

    .section-header {
        background: #34495e;
        color: white;
        padding: 20px;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .section-content {
        padding: 25px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .info-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
    }

    .info-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }

    .info-value {
        color: #34495e;
    }

    .library-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .library-table th,
    .library-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .library-table th {
        background-color: #34495e;
        color: white;
        font-weight: 600;
    }

    .status-vulnerable {
        background-color: #fdf2f2;
        color: #e74c3c;
    }

    .status-safe {
        background-color: #f0f9f0;
        color: #27ae60;
    }

    .status-unknown {
        background-color: #fff3cd;
        color: #856404;
    }


    .print-button {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 1000;
    }

    @media print {
        .print-button, .navbar, .btn, .project-breadcrumb { display: none !important; }
        .report-container { max-width: 100%; }
    }
</style>
{% endblock %}

{% block content %}
<div class="report-container">
    <!-- Breadcrumb de navegaci√≥n -->
    <div class="project-breadcrumb">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('projects') }}">Proyectos</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                <li class="breadcrumb-item active">Reporte Consolidado</li>
            </ol>
        </nav>
    </div>

    <!-- Print Button -->
    <button class="print-button btn btn-primary" onclick="window.print()">
        <i class="bi bi-printer"></i>
        Imprimir Reporte
    </button>

    <!-- Dashboard Header Moderno -->
    <div class="dashboard-header dashboard-animate">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="dashboard-title">
                    <i class="bi bi-folder-check me-3"></i>
                    Reporte Consolidado de Proyecto
                </h1>
                <p class="dashboard-subtitle">
                    <i class="bi bi-building me-2"></i>
                    {{ project.name }}
                </p>
                <div class="d-flex gap-3 text-white-50">
                    <span><i class="bi bi-globe me-1"></i>{{ project_stats.total_urls }} URLs analizadas</span>
                    <span><i class="bi bi-check-circle me-1"></i>{{ project_stats.total_scans }} escaneos consolidados</span>
                    <span><i class="bi bi-calendar-event me-1"></i>Generado autom√°ticamente</span>
                </div>
                {% if project.description %}
                <div class="mt-2 text-white-75" style="font-size: 0.9rem;">
                    <i class="bi bi-info-circle me-1"></i>{{ project.description }}
                </div>
                {% endif %}
            </div>
            <div class="col-md-4 text-center">
                <div class="modern-score-circle {{ 'excellent' if consolidated_security_analysis.security_score >= 80 else 'good' if consolidated_security_analysis.security_score >= 60 else 'poor' }}">
                    {{ consolidated_security_analysis.security_score }}%
                </div>
                <div class="mt-2 text-white-50 small">Puntuaci√≥n Consolidada de Seguridad</div>
            </div>
        </div>
    </div>

    <!-- Executive Summary Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.3s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-clipboard-data"></i>
                    <span>Resumen Ejecutivo del Proyecto</span>
                </div>
                <div class="card-body modern-card-body">
                    <div class="row mb-4 justify-content-center">
                        <div class="col-lg-6 mb-4">
                            <div class="card modern-chart-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-search"></i>
                                        Hallazgos Principales del Proyecto:
                                    </h6>
                                </div>
                                <div class="card-body modern-card-body">
                                    <!-- Consolidated Statistics -->
                                    <div class="consolidated-stats">
                                        <div class="stat-card">
                                            <div class="stat-number">{{ project_stats.total_urls }}</div>
                                            <div class="stat-label">URLs √önicas</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number">{{ project_stats.total_libraries }}</div>
                                            <div class="stat-label">Bibliotecas Encontradas</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number {{ 'text-danger' if project_stats.total_vulnerabilities > 0 else 'text-success' }}">{{ project_stats.total_vulnerabilities }}</div>
                                            <div class="stat-label">Vulnerabilidades Detectadas</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number">{{ project_stats.total_files }}</div>
                                            <div class="stat-label">Archivos JavaScript</div>
                                        </div>
                                    </div>

                                    <!-- Key Findings -->
                                    <div class="mt-4">
                                        <ul class="list-unstyled">
                                            {% if project_stats.total_vulnerabilities > 0 %}
                                            <li class="mb-2">
                                                <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                                                <strong>{{ project_stats.total_vulnerabilities }}</strong> {{ 'vulnerabilidad detectada' if project_stats.total_vulnerabilities == 1 else 'vulnerabilidades detectadas' }} en el conjunto de URLs del proyecto
                                            </li>
                                            {% endif %}

                                            {% if consolidated_security_analysis.security_score < 70 %}
                                            <li class="mb-2">
                                                <i class="bi bi-shield-exclamation text-warning me-2"></i>
                                                Los encabezados de seguridad HTTP requieren mejoras (Puntuaci√≥n: <strong>{{ consolidated_security_analysis.security_score }}%</strong>)
                                            </li>
                                            {% endif %}

                                            {% if consolidated_security_analysis.missing|length > 0 %}
                                            <li class="mb-2">
                                                <i class="bi bi-shield-x text-warning me-2"></i>
                                                <strong>{{ consolidated_security_analysis.missing|length }}</strong> {{ 'encabezado cr√≠tico de seguridad falta' if consolidated_security_analysis.missing|length == 1 else 'encabezados cr√≠ticos de seguridad faltan' }} en algunas URLs
                                            </li>
                                            {% endif %}

                                            {% if project_stats.total_vulnerabilities == 0 and consolidated_security_analysis.security_score >= 70 %}
                                            <li class="mb-2">
                                                <i class="bi bi-shield-check-fill text-success me-2"></i>
                                                Excelente postura de seguridad general - No se identificaron vulnerabilidades cr√≠ticas
                                            </li>
                                            {% endif %}

                                            <li class="mb-2">
                                                <i class="bi bi-folder text-info me-2"></i>
                                                El proyecto <strong>{{ project.name }}</strong> incluye an√°lisis de <strong>{{ project_stats.total_urls }}</strong> URLs √∫nicas con datos consolidados
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Gr√°fico 1: Estado General de Bibliotecas -->
                        <div class="col-lg-6 mb-4">
                            <div class="card modern-chart-card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-shield-check me-2 text-primary"></i>
                                        Estado de Bibliotecas Consolidado
                                    </h6>
                                </div>
                                <div class="card-body" style="height: 320px; position: relative;">
                                    <div style="height: 200px; position: relative;">
                                        <canvas id="consolidatedSecurityDonut"></canvas>
                                    </div>
                                    <!-- Calcular datos consolidados -->
                                    {% set consolidated_vuln = namespace(value=0) %}
                                    {% set consolidated_safe = namespace(value=0) %}
                                    {% set consolidated_unknown = namespace(value=0) %}

                                    {% for lib in consolidated_libraries %}
                                        {% if lib.version | check_vulnerability_with_global(lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                            {% set consolidated_vuln.value = consolidated_vuln.value + 1 %}
                                        {% elif lib.latest_safe_version %}
                                            {% set consolidated_safe.value = consolidated_safe.value + 1 %}
                                        {% else %}
                                            {% set consolidated_unknown.value = consolidated_unknown.value + 1 %}
                                        {% endif %}
                                    {% endfor %}

                                    <div class="chart-summary">
                                        <div class="text-center">
                                            <span class="modern-badge danger me-2">
                                                <i class="bi bi-exclamation-triangle-fill"></i>
                                                {{ consolidated_vuln.value }} Vulnerables
                                            </span>
                                            <span class="modern-badge success me-2">
                                                <i class="bi bi-shield-check"></i>
                                                {{ consolidated_safe.value }} Seguras
                                            </span>
                                            <span class="modern-badge warning">
                                                <i class="bi bi-question-circle"></i>
                                                {{ consolidated_unknown.value }} Sin Datos
                                            </span>
                                        </div>
                                        <div class="mt-2 text-center">
                                            <small class="text-muted">
                                                Total: {{ consolidated_vuln.value + consolidated_safe.value + consolidated_unknown.value }} bibliotecas √∫nicas
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Datos ocultos para JavaScript -->
                                    <div style="display: none;"
                                         data-consolidated-vuln="{{ consolidated_vuln.value }}"
                                         data-consolidated-safe="{{ consolidated_safe.value }}"
                                         data-consolidated-unknown="{{ consolidated_unknown.value }}"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico 2 -->
                        <!--div class="row mb-4 justify-content-center">
                            <div class="col-lg-6 mb-4">
                                <div class="card modern-chart-card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-speedometer2 me-2 text-info"></i>
                                            Puntuaci√≥n Consolidada
                                        </h6>
                                    </div>
                                    <div class="card-body text-center" style="height: 320px; display: flex; flex-direction: column; justify-content: center;">
                                        <div style="height: 120px; position: relative;">
                                            <canvas id="consolidatedSecurityGauge"></canvas>
                                        </div>
                                        <div class="mt-3">
                                            <h4 class="mb-1" style="color: {{ '#22c55e' if consolidated_security_analysis.security_score >= 75 else '#f59e0b' if consolidated_security_analysis.security_score >= 50 else '#ef4444' }}">
                                                {{ consolidated_security_analysis.security_score }}%
                                            </h4>
                                            <small class="text-muted">Puntuaci√≥n Consolidada</small>
                                        </div>

                                        <div class="chart-summary mt-2">
                                            <div class="d-flex justify-content-center gap-2 flex-wrap">
                                                {% if consolidated_security_analysis.security_score >= 80 %}
                                                    <span class="modern-badge success">
                                                        <i class="bi bi-star-fill"></i>
                                                        Excelente
                                                    </span>
                                                {% elif consolidated_security_analysis.security_score >= 60 %}
                                                    <span class="modern-badge warning">
                                                        <i class="bi bi-check-circle"></i>
                                                        Bueno
                                                    </span>
                                                {% else %}
                                                    <span class="modern-badge danger">
                                                        <i class="bi bi-exclamation-triangle"></i>
                                                        Necesita Mejoras
                                                    </span>
                                                {% endif %}
                                                <span class="modern-badge info">
                                                    <i class="bi bi-shield"></i>
                                                    {{ consolidated_security_analysis.present|length if consolidated_security_analysis.present else 0 }}/{{ (consolidated_security_analysis.present|length + consolidated_security_analysis.missing|length) if consolidated_security_analysis else 0 }} Headers
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Datos ocultos para JavaScript -->
                                        <div style="display: none;" data-consolidated-security-score="{{ consolidated_security_analysis.security_score }}"></div>
                                    </div>
                                </div>
                            </div>
                        </div-->

                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Matrix Heatmap: Cobertura de Headers por URL -->
    <div class="row dashboard-animate" style="animation-delay: 0.35s;">
        <div class="col-12">
            <div class="card modern-chart-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-grid-3x3-gap me-2"></i>
                    <span>Matriz de Cobertura de Headers de Seguridad</span>
                </div>
                <div class="card-body modern-card-body">
                    <div id="headersMatrixHeatmap mb-4">
                        <div class="heatmap-container">
                            <table class="heatmap-table">
                                <thead>
                                    <tr>
                                        <th class="url-header">URL del Proyecto</th>
                                        {% set security_headers = ['Strict-Transport-Security', 'Content-Security-Policy', 'X-Frame-Options', 'X-Content-Type-Options', 'Cross-Origin-Embedder-Policy', 'Cross-Origin-Opener-Policy', 'Referrer-Policy', 'Permissions-Policy', 'Cross-Origin-Resource-Policy', 'X-XSS-Protection', 'Expect-CT', 'Origin-Agent-Cluster'] %}
                                        {% for header in security_headers %}
                                        <th title="{{ header }}">
                                            {% if header == 'Strict-Transport-Security' %}HSTS
                                            {% elif header == 'Content-Security-Policy' %}CSP
                                            {% elif header == 'X-Frame-Options' %}Frame
                                            {% elif header == 'X-Content-Type-Options' %}Content
                                            {% elif header == 'Cross-Origin-Embedder-Policy' %}COEP
                                            {% elif header == 'Cross-Origin-Opener-Policy' %}COOP
                                            {% elif header == 'Referrer-Policy' %}Referrer
                                            {% elif header == 'Permissions-Policy' %}Permissions
                                            {% elif header == 'Cross-Origin-Resource-Policy' %}CORP
                                            {% elif header == 'X-XSS-Protection' %}XSS
                                            {% elif header == 'Expect-CT' %}CT
                                            {% elif header == 'Origin-Agent-Cluster' %}OAC
                                            {% else %}{{ header.split('-')[0] }}
                                            {% endif %}
                                        </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for url_data in urls_data %}
                                    <tr data-url="{{ url_data.scan.url }}">
                                        <td class="url-cell" title="{{ url_data.scan.url }}">
                                            {% set clean_url = url_data.scan.url.split('://')[1] if '://' in url_data.scan.url else url_data.scan.url %}
                                            {{ clean_url }}
                                        </td>
                                        {% for header in security_headers %}
                                        <td class="data-cell {{ 'present' if header in url_data.headers else 'missing' }}"
                                            title="{{ header }}: {{ 'Presente ‚úì' if header in url_data.headers else 'Ausente ‚úó' }} en {{ clean_url }}"
                                            data-header="{{ header }}"
                                            data-status="{{ 'present' if header in url_data.headers else 'missing' }}">
                                            {{ '‚óè' if header in url_data.headers else '‚óã' }}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Leyenda mejorada -->
                        <div class="heatmap-legend">
                            <div class="d-flex justify-content-center gap-4 flex-wrap mb-2">
                                <div class="legend-item">
                                    <span class="legend-dot present">‚óè</span>
                                    <small><strong>Header Presente</strong></small>
                                </div>
                                <div class="legend-item">
                                    <span class="legend-dot missing">‚óã</span>
                                    <small><strong>Header Ausente</strong></small>
                                </div>
                            </div>
                            <div class="text-center mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-cursor me-1"></i>
                                    Pasa el cursor sobre cada celda para ver detalles completos del header
                                </small>
                            </div>

                            <!-- Leyenda de Abreviaciones -->
                            <div class="headers-abbreviations">
                                <h6 class="mb-2 text-center">
                                    <i class="bi bi-list-ul"></i>
                                    Abreviaciones de Headers
                                </h6>
                                <div class="row small">
                                    <div class="col-md-4">
                                        <strong>Cr√≠ticos:</strong><br>
                                        <span class="text-danger">HSTS</span>: Strict-Transport-Security<br>
                                        <span class="text-danger">CSP</span>: Content-Security-Policy
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Altos:</strong><br>
                                        <span class="text-warning">Frame</span>: X-Frame-Options<br>
                                        <span class="text-warning">Content</span>: X-Content-Type-Options<br>
                                        <span class="text-warning">COEP</span>: Cross-Origin-Embedder-Policy<br>
                                        <span class="text-warning">COOP</span>: Cross-Origin-Opener-Policy
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Medios/Bajos:</strong><br>
                                        <span class="text-info">Referrer</span>: Referrer-Policy<br>
                                        <span class="text-info">Permissions</span>: Permissions-Policy<br>
                                        <span class="text-info">CORP</span>: Cross-Origin-Resource-Policy<br>
                                        <span class="text-secondary">XSS</span>: X-XSS-Protection<br>
                                        <span class="text-secondary">CT</span>: Expect-CT<br>
                                        <span class="text-secondary">OAC</span>: Origin-Agent-Cluster
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>




    <!-- Consolidated Libraries Analysis Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.4s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-bookshelf"></i>
                    <span>Inventario Consolidado de Bibliotecas JavaScript</span>
                </div>
                <div class="card-body modern-card-body">
        <div class="section-content">
            {% if consolidated_libraries %}
                <table class="library-table">
                    <thead>
                        <tr>
                            <th>Biblioteca / Framework</th>
                            <th>Versi√≥n</th>
                            <th>Estado de Seguridad</th>
                            <th>Usado en URLs</th>
                            <th>Recomendaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lib in consolidated_libraries %}
                        {% set effective_safe = lib.latest_safe_version | get_effective_safe_version(lib.gl_latest_safe_version) %}
                        {% set has_vuln = lib.version | check_vulnerability_with_global(lib.latest_safe_version, lib.gl_latest_safe_version) %}
                        <tr class="{{ 'status-vulnerable' if has_vuln else 'status-safe' if lib.latest_safe_version else 'status-unknown' }}">
                            <td>
                                <strong>{{ lib.library_name }}</strong>
                                {% if lib.description %}
                                <br><small class="text-muted">{{ lib.description }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <code>{{ lib.version or 'Desconocida' }}</code>
                            </td>
                            <td>
                                {% if has_vuln %}
                                    <span class="modern-badge danger">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        VULNERABLE
                                    </span>
                                {% elif lib.latest_safe_version %}
                                    <span class="modern-badge success">
                                        <i class="bi bi-shield-check"></i>
                                        SEGURA
                                    </span>
                                {% else %}
                                    <span class="modern-badge warning">
                                        <i class="bi bi-question-circle"></i>
                                        SIN DATOS
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="library-usage-info">
                                    <strong>{{ lib.scan_count }} {{ 'URL' if lib.scan_count == 1 else 'URLs' }}</strong>

                                </div>
                            </td>
                            <td>
                                {% if has_vuln %}
                                    <strong class="text-danger">Actualizar urgentemente</strong>
                                    {% if effective_safe %}
                                    <br><small>Versi√≥n segura: {{ effective_safe }}</small>
                                    {% endif %}
                                {% elif lib.latest_safe_version %}
                                    <span class="text-success">‚úì Versi√≥n actual es segura</span>
                                {% else %}
                                    <span class="text-warning">Revisi√≥n manual requerida</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-bookshelf display-4 text-muted"></i>
                    <h5 class="mt-3">No se Detectaron Bibliotecas</h5>
                    <p class="text-muted">No se detectaron bibliotecas JavaScript en los escaneos revisados de este proyecto.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Consolidated Security Headers Analysis -->
    <div class="section-card">
        <div class="section-header">
            <i class="bi bi-shield-check"></i>
            An√°lisis Consolidado de Encabezados de Seguridad
        </div>
        <div class="section-content">
            <p class="mb-4">
                Este an√°lisis muestra el estado de los encabezados de seguridad HTTP consolidado para todas las
                <strong>{{ consolidated_security_analysis.total_urls }}</strong> URLs del proyecto.
            </p>


            <!-- Headers Present Across Project -->
            {% if consolidated_security_analysis.present %}
                <h6 class="mt-4 mb-3 text-success">
                    <i class="bi bi-check-circle-fill"></i>
                    Encabezados de Seguridad Implementados
                </h6>
                <table class="library-table">
                    <thead>
                        <tr>
                            <th>Encabezado HTTP</th>
                            <th>Presente en URLs</th>
                            <th>Ausente en URLs</th>
                            <th>Valor Ejemplo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for header in consolidated_security_analysis.present %}
                        <tr class="status-safe">
                            <td><strong>{{ header.name }}</strong></td>
                            <td>
                                <span class="modern-badge success">{{ header.present_in_urls|length }}</span>
                                {% if header.missing_in_urls|length > 0 %}
                                    <small class="text-muted d-block">
                                        Falta en {{ header.missing_in_urls|length }} URLs
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                {% if header.missing_in_urls|length > 0 %}
                                    <span class="modern-badge warning">{{ header.missing_in_urls|length }}</span>
                                {% else %}
                                    <span class="modern-badge success">0</span>
                                {% endif %}
                            </td>
                            <td>
                                <code style="font-size: 0.8rem;">{{ header.value[:50] }}{{ '...' if header.value|length > 50 else '' }}</code>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            <!-- Headers Missing Across Project -->
            {% if consolidated_security_analysis.missing %}
                <h6 class="mt-4 mb-3 text-danger">
                    <i class="bi bi-x-circle-fill"></i>
                    Encabezados de Seguridad Faltantes en Todas las URLs
                </h6>
                <table class="library-table">
                    <thead>
                        <tr>
                            <th>Encabezado Faltante</th>
                            <th>Impacto en Seguridad</th>
                            <th>Configuraci√≥n Recomendada</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for header in consolidated_security_analysis.missing %}
                        <tr class="status-vulnerable">
                            <td><strong>{{ header.name }}</strong></td>
                            <td>{{ header.description }}</td>
                            <td>
                                <code style="font-size: 0.8rem;">{{ header.recommendation }}</code>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis by URL Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.5s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-list-ul"></i>
                    <span>An√°lisis Detallado por URL</span>
                </div>
                <div class="card-body modern-card-body">
            <p class="mb-4">
                An√°lisis individual de cada URL incluida en el proyecto (solo se muestran los escaneos m√°s recientes y revisados).
            </p>

            <div class="urls-analysis-section">
                {% for url_data in urls_data %}
                <div class="url-card">
                    <div class="url-header">
                        <h6 class="url-title">
                            <a href="{{ url_data.scan.url }}" target="_blank" class="text-decoration-none">
                                {{ url_data.scan.url }}
                            </a>
                        </h6>
                        <div class="url-meta">
                            <i class="bi bi-calendar me-1"></i>{{ url_data.scan.scan_date }}
                            <span class="ms-3"><i class="bi bi-files me-1"></i>{{ url_data.libraries|length }} bibliotecas</span>
                            <span class="ms-3"><i class="bi bi-shield me-1"></i>{{ url_data.security_analysis.security_score }}% seguridad</span>
                        </div>
                    </div>
                    <div class="url-content">
                        <!-- URL Libraries -->
                        {% if url_data.libraries %}
                        <div class="url-libraries">
                            <h6><i class="bi bi-bookshelf me-2"></i>Bibliotecas JavaScript:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                {% for lib in url_data.libraries %}
                                {% set has_vuln = lib.version | check_vulnerability_with_global(lib.latest_safe_version, lib.gl_latest_safe_version) %}
                                <span class="modern-badge {{ 'danger' if has_vuln else 'success' if lib.latest_safe_version else 'warning' }}">
                                    {{ lib.library_name }} {{ lib.version or '?' }}
                                    {% if has_vuln %}‚ö†Ô∏è{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- URL Security Score -->
                        <div class="url-security">
                            <h6><i class="bi bi-shield-check me-2"></i>Puntuaci√≥n de Seguridad:
                                <span class="badge {{ 'bg-success' if url_data.security_analysis.security_score >= 80 else 'bg-warning' if url_data.security_analysis.security_score >= 60 else 'bg-danger' }}">
                                    {{ url_data.security_analysis.security_score }}%
                                </span>
                            </h6>
                            {% if url_data.security_analysis.missing %}
                            <small class="text-muted">
                                Faltan {{ url_data.security_analysis.missing|length }} encabezados de seguridad
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Libraries Analysis Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.55s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <span>Bibliotecas que Requieren Atenci√≥n Inmediata</span>
                </div>
                <div class="card-body modern-card-body">
                    {% set vulnerable_entries = [] %}
                    {% set unknown_entries = [] %}

                    {# Create individual entries for each library-site-source combination #}
                    {% for lib in consolidated_libraries %}
                        {% set has_vuln = lib.version | check_vulnerability_with_global(lib.latest_safe_version, lib.gl_latest_safe_version) %}

                        {# Create cross product of scan_urls and source_urls #}
                        {% for scan_url in lib.scan_urls %}
                            {% if lib.source_urls_list %}
                                {% for source_url in lib.source_urls_list %}
                                    {% set entry = {
                                        'scan_url': scan_url,
                                        'source_url': source_url,
                                        'library_name': lib.library_name,
                                        'version': lib.version,
                                        'description': lib.description,
                                        'latest_safe_version': lib.latest_safe_version,
                                        'gl_latest_safe_version': lib.gl_latest_safe_version
                                    } %}

                                    {% if has_vuln %}
                                        {% set _ = vulnerable_entries.append(entry) %}
                                    {% elif not lib.latest_safe_version and not lib.gl_latest_safe_version %}
                                        {% set _ = unknown_entries.append(entry) %}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {# Handle libraries without source URLs #}
                                {% set entry = {
                                    'scan_url': scan_url,
                                    'source_url': None,
                                    'library_name': lib.library_name,
                                    'version': lib.version,
                                    'description': lib.description,
                                    'latest_safe_version': lib.latest_safe_version,
                                    'gl_latest_safe_version': lib.gl_latest_safe_version
                                } %}

                                {% if has_vuln %}
                                    {% set _ = vulnerable_entries.append(entry) %}
                                {% elif not lib.latest_safe_version and not lib.gl_latest_safe_version %}
                                    {% set _ = unknown_entries.append(entry) %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endfor %}

                    {# Sort entries by scan_url (site) #}
                    {% set vulnerable_entries = vulnerable_entries | sort(attribute='scan_url') %}
                    {% set unknown_entries = unknown_entries | sort(attribute='scan_url') %}

                    {% if vulnerable_entries or unknown_entries %}
                        <!-- Vulnerable Libraries Section -->
                        {% if vulnerable_entries %}
                        <div class="mb-4">
                            <h5 class="text-danger mb-3">
                                <i class="bi bi-shield-exclamation me-2"></i>
                                Bibliotecas Vulnerables ({{ vulnerable_entries|length }})
                                <small class="text-muted">- Actualizaci√≥n Urgente Requerida</small>
                            </h5>
                            <div class="table-responsive">
                                <table class="library-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 25%">Sitio Escaneado</th>
                                            <th style="width: 20%">Biblioteca</th>
                                            <th style="width: 10%">Versi√≥n Actual</th>
                                            <th style="width: 15%">Versi√≥n Segura</th>
                                            <th style="width: 30%">Archivo Fuente</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in vulnerable_entries %}
                                        {% set effective_safe = entry.latest_safe_version | get_effective_safe_version(entry.gl_latest_safe_version) %}
                                        <tr class="status-vulnerable">
                                            <td>
                                                <div class="mb-1">
                                                    <i class="bi bi-globe text-info me-1"></i>
                                                    <a href="{{ entry.scan_url }}" target="_blank" class="text-decoration-none" style="font-size: 0.85rem; word-break: break-all;">
                                                        {{ entry.scan_url }}
                                                    </a>
                                                </div>
                                            </td>
                                            <td>
                                                <strong class="text-danger">{{ entry.library_name }}</strong>
                                                {% if entry.description %}
                                                <br><small class="text-muted">{{ entry.description }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="modern-badge danger">
                                                    <i class="bi bi-exclamation-triangle-fill"></i>
                                                    {{ entry.version or 'Desconocida' }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if effective_safe %}
                                                    <span class="modern-badge success">{{ effective_safe }}</span>
                                                    {% if entry.gl_latest_safe_version and not entry.latest_safe_version %}
                                                        <br><small class="text-info">(versi√≥n global)</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">No disponible</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if entry.source_url %}
                                                    <div class="mb-1">
                                                        <i class="bi bi-file-earmark-code text-primary me-1"></i>
                                                        <a href="{{ entry.source_url }}" target="_blank" class="text-decoration-none" style="font-size: 0.85rem; word-break: break-all;">
                                                            {{ entry.source_url }}
                                                        </a>
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">URL no disponible</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}


                    {% else %}
                        <div class="text-center p-4">
                            <i class="bi bi-shield-check-fill display-4 text-success mb-3"></i>
                            <h5 class="text-success">¬°Excelente!</h5>
                            <p class="text-muted">No se detectaron bibliotecas vulnerables ni que requieran revisi√≥n manual en este proyecto.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Project Recommendations Card -->
    <div class="row dashboard-animate" style="animation-delay: 0.6s;">
        <div class="col-12">
            <div class="card modern-card">
                <div class="card-header modern-card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <i class="bi bi-lightbulb"></i>
                    <span>Recomendaciones Consolidadas del Proyecto</span>
                </div>
                <div class="card-body modern-card-body">
            {# Use the vulnerable_entries that were already created above #}
            {% if vulnerable_entries %}
            <h6 class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Prioridad Alta - Todas las Vulnerabilidades ({{ vulnerable_entries|length }})</h6>
            <div class="alert alert-danger">
                <ul class="mb-0">
                    {% for entry in vulnerable_entries %}
                    <li>
                        <strong>{{ entry.library_name }}</strong> versi√≥n {{ entry.version }}
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-globe me-1"></i>Sitio: <a href="{{ entry.scan_url }}" target="_blank" class="text-dark">{{ entry.scan_url }}</a>
                            {% if entry.source_url %}
                            <br><i class="bi bi-file-earmark-code me-1"></i>Archivo: <a href="{{ entry.source_url }}" target="_blank" class="text-dark">{{ entry.source_url }}</a>
                            {% endif %}
                        </small>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if consolidated_security_analysis.missing %}
            <h6 class="text-warning mt-4"><i class="bi bi-shield-plus me-2"></i>Mejorar Seguridad HTTP</h6>
            <div class="alert alert-warning">
                <p>Implementar los siguientes encabezados de seguridad en todas las URLs:</p>
                <ul class="mb-0">
                    {% for header in consolidated_security_analysis.missing[:3] %}
                    <li><strong>{{ header.name }}:</strong> {{ header.description }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if consolidated_security_analysis.security_score >= 70 and project_stats.total_vulnerabilities == 0 %}
            <h6 class="text-success"><i class="bi bi-check-circle-fill me-2"></i>Buena Postura de Seguridad</h6>
            <div class="alert alert-success">
                <ul class="mb-0">
                    <li>El proyecto mantiene un buen nivel de seguridad general</li>
                    <li>Continuar monitoreando nuevas vulnerabilidades regularmente</li>
                    <li>Mantener las bibliotecas actualizadas</li>
                </ul>
            </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Dashboard -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card modern-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body text-center py-4">
            <h5><i class="bi bi-cpu me-2"></i> Reporte Consolididado de An√°lisis de Seguridad Web <br />
            <i class="bi bi-folder-check me-2"></i>Proyecto: {{ project.name }}
            </h5>
            <p class="mb-0">
                {% if project.website %}
                <i class="bi bi-link me-2"></i> URL: <a href="{{ project.website }}" target="_blank" class="text-white">{{ project.website }}</a>
                {% endif %}
            </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN - Reutilizar del enhanced_report -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
// Datos del proyecto pasados desde Python
const projectStats = {{ project_stats_json | safe }};
const consolidatedLibraries = {{ consolidated_libraries_json | safe }};
const urlsData = {{ urls_data_json | safe }};

console.log('üé® Reporte consolidado del proyecto cargado');
console.log('üìä Estad√≠sticas del proyecto:', projectStats);
console.log('üìö Bibliotecas consolidadas:', consolidatedLibraries.length);
console.log('üåê URLs analizadas:', urlsData.length);

// Inicializar gr√°ficos consolidados
document.addEventListener('DOMContentLoaded', function() {
    console.log('üé® DOM listo, verificando Chart.js...');

    // Peque√±o delay para asegurar que Chart.js est√© listo
    setTimeout(function() {
        if (typeof Chart !== 'undefined') {
            console.log('‚úÖ Chart.js disponible, inicializando gr√°ficos consolidados...');
            initConsolidatedCharts();
        } else {
            console.error('‚ùå Chart.js no est√° disponible');
            showConsolidatedChartError();
        }
    }, 500);
});

// Funci√≥n principal para inicializar gr√°ficos consolidados
function initConsolidatedCharts() {
    const chartData = extractConsolidatedChartData();

    if (chartData) {
        console.log('üìä Datos consolidados extra√≠dos:', chartData);

        // Inicializar gr√°ficos consolidados
        initConsolidatedSecurityDonut(chartData.security);
        initConsolidatedSecurityGauge(chartData.securityScore);
    } else {
        console.warn('‚ö†Ô∏è No se pudieron extraer los datos consolidados');
    }
}

// Extraer datos consolidados
function extractConsolidatedChartData() {
    try {
        const vulnEl = document.querySelector('[data-consolidated-vuln]');
        const safeEl = document.querySelector('[data-consolidated-safe]');
        const unknownEl = document.querySelector('[data-consolidated-unknown]');
        const scoreEl = document.querySelector('[data-consolidated-security-score]');

        if (!vulnEl || !safeEl || !unknownEl || !scoreEl) {
            console.warn('‚ö†Ô∏è No se encontraron todos los elementos de datos consolidados');
            return null;
        }

        return {
            security: {
                vulnerable: parseInt(vulnEl.dataset.consolidatedVuln) || 0,
                safe: parseInt(safeEl.dataset.consolidatedSafe) || 0,
                unknown: parseInt(unknownEl.dataset.consolidatedUnknown) || 0
            },
            securityScore: parseInt(scoreEl.dataset.consolidatedSecurityScore) || 0
        };
    } catch (error) {
        console.error('‚ùå Error extrayendo datos consolidados:', error);
        return null;
    }
}

// Gr√°fico donut consolidado de seguridad
function initConsolidatedSecurityDonut(data) {
    const ctx = document.getElementById('consolidatedSecurityDonut');
    if (!ctx) return;

    const total = data.vulnerable + data.safe + data.unknown;
    if (total === 0) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Vulnerables', 'Seguras', 'Sin Datos'],
            datasets: [{
                data: [data.vulnerable, data.safe, data.unknown],
                backgroundColor: ['#ef4444', '#22c55e', '#94a3b8'],
                borderWidth: 0,
                cutout: '65%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false  // Usamos badges personalizados
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} bibliotecas (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    console.log('‚úÖ Gr√°fico donut consolidado inicializado');
}


// Gauge consolidado de puntuaci√≥n
function initConsolidatedSecurityGauge(score) {
    const ctx = document.getElementById('consolidatedSecurityGauge');
    if (!ctx) return;

    let scoreColor = '#22c55e';
    if (score < 50) scoreColor = '#ef4444';
    else if (score < 75) scoreColor = '#f59e0b';

    const remaining = 100 - score;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [score, remaining],
                backgroundColor: [scoreColor, '#f1f5f9'],
                borderWidth: 0,
                cutout: '80%'
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.dataIndex === 0) {
                                return `Puntuaci√≥n Consolidada: ${score}%`;
                            }
                            return null;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 1800,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('‚úÖ Gauge consolidado inicializado');
}



// Mostrar error si Chart.js no carga
function showConsolidatedChartError() {
    const containers = ['consolidatedSecurityDonut', 'consolidatedSecurityGauge'];

    containers.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            canvas.parentElement.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                    <h6>Error cargando gr√°ficos</h6>
                    <small>Chart.js no disponible</small>
                </div>
            `;
        }
    });
}
</script>
{% endblock %}
