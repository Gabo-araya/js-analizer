<!doctype html>
<html lang="es-CL">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            {% block title %}Analizador de Bibliotecas JavaScript{% endblock %}
        </title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"
        />
        <link
            href="{{ url_for('static', filename='css/main.css') }}"
            rel="stylesheet"
        />
        <link
            href="{{ url_for('static', filename='img/favicon.png') }}"
            rel="shortcut icon"
        />
    </head>
    <body class="bg-light">
        {% if session.user_id %}
        <nav
            class="navbar navbar-expand-lg navbar-light bg-white border-bottom"
        >
            <div class="container-fluid">
                <a class="navbar-brand" href="/"
                    ><i class="bi bi-shield-check"></i> Analizador de
                    Bibliotecas JS</a
                >
                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav"
                    aria-controls="navbarNav"
                    aria-expanded="false"
                    aria-label="Alternar navegación"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'dashboard' else '' }}"
                                href="/"
                                ><i class="bi bi-grid-1x2-fill"></i>
                                Dashboard</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'statistics' else '' }}"
                                href="/statistics"
                                ><i class="bi bi-bar-chart-line"></i>
                                Estadísticas</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'projects' else '' }}"
                                href="/projects"
                                ><i class="bi bi-diagram-3"></i> Proyectos</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'global_libraries' else '' }}"
                                href="/global-libraries"
                                ><i class="bi bi-collection"></i> Bibliotecas</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'ayuda' else '' }}"
                                href="/ayuda"
                                ><i class="bi bi-question-circle"></i> Ayuda</a
                            >
                        </li>

                        {% if session.user_role == 'admin' %}
                        <li class="nav-item">
                            <a
                                class="nav-link {{ 'active' if current_page == 'users' else '' }}"
                                href="/users"
                                ><i class="bi bi-people-fill"></i> Usuarios</a
                            >
                        </li>
                        {% endif %}
                        <li class="nav-item">.</li>
                        <li class="nav-item">
                            <a
                                class="nav-link"
                                href="https://security.snyk.io/vuln"
                                target="_blank"
                                ><i class="bi bi-box-arrow-up-right"></i>
                                Snyk</a
                            >
                        </li>
                        <li class="nav-item">
                            <a
                                class="nav-link"
                                href="https://www.cvedetails.com/"
                                target="_blank"
                                ><i class="bi bi-box-arrow-up-right"></i>
                                CVE-Details</a
                            >
                        </li>
                    </ul>
                    <ul class="navbar-nav">
                        {% if session.user_id %}
                        <li class="nav-item dropdown">
                            <a
                                class="nav-link dropdown-toggle"
                                href="#"
                                id="navbarDropdown"
                                role="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="bi bi-person-circle"></i> {{
                                session.username }}
                                <span
                                    class="badge bg-{{ 'primary' if session.user_role == 'admin' else 'secondary' }} ms-1"
                                    >{{ session.user_role | title }}</span
                                >
                            </a>
                            <ul
                                class="dropdown-menu dropdown-menu-end"
                                aria-labelledby="navbarDropdown"
                            >
                                <li>
                                    <h6 class="dropdown-header">
                                        <i
                                            class="bi bi-shield-{{ 'fill' if session.user_role == 'admin' else 'check' }}"
                                        ></i>
                                        {{ 'Administrador' if session.user_role
                                        == 'admin' else 'Analista' }}
                                    </h6>
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a
                                        class="dropdown-item"
                                        href="#"
                                        data-bs-toggle="modal"
                                        data-bs-target="#changeOwnPasswordModal"
                                        ><i class="bi bi-key"></i> Cambiar
                                        Contraseña</a
                                    >
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a class="dropdown-item" href="/logout"
                                        ><i class="bi bi-box-arrow-right"></i>
                                        Cerrar Sesión</a
                                    >
                                </li>
                            </ul>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        {% endif %}

        <div class="container-fluid p-4">
            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %} {%
            if messages %} {% for category, message in messages %}
            <div
                class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
                role="alert"
            >
                {{ message|e }}
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="alert"
                    aria-label="Cerrar"
                ></button>
            </div>
            {% endfor %} {% endif %} {% endwith %} {% block content %}{%
            endblock %}
        </div>

        <!-- Change Own Password Modal -->
        {% if session.user_id %}
        <div
            class="modal fade"
            id="changeOwnPasswordModal"
            tabindex="-1"
            aria-labelledby="changeOwnPasswordModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5
                            class="modal-title"
                            id="changeOwnPasswordModalLabel"
                        >
                            <i class="bi bi-key"></i> Cambiar Mi Contraseña
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Cerrar"
                        ></button>
                    </div>
                    <form
                        method="POST"
                        action="{{ url_for('change_own_password') }}"
                    >
                        <input
                            type="hidden"
                            name="csrf_token"
                            value="{{ csrf_token() }}"
                        />
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="current_password" class="form-label"
                                    >Contraseña Actual</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="current_password"
                                    name="current_password"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="new_password" class="form-label"
                                    >Nueva Contraseña</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="new_password"
                                    name="new_password"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label"
                                    >Confirmar Nueva Contraseña</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="confirm_password"
                                    name="confirm_password"
                                    required
                                />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button
                                type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                            >
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Cambiar Contraseña
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{{ url_for('static', filename='js/secure_event_handlers.js') }}"></script>
        {% block scripts %}{% endblock %}
    </body>
</html>
